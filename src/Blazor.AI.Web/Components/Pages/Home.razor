@page "/"
@rendermode InteractiveServer

@using Markdig

<PageTitle>Dotnet RAG Chat</PageTitle>

<h1>Welcome to chat</h1>

<p>This Dotnet Blazor app uses Semantic Kernel orchestrating Azure AI Search and Azure OpenAI for RAG pattern from Word documents stored in Azure Blob Storage Account.</p>

<FluentCard Style="display: flex; flex-direction: column">
    <div class="chat-header">
        <FluentHeader Style="border-radius: 5px; width: 100%;">
            Chat
            <FluentSpacer />
            <FluentButton @onclick="this.ClearChat" Appearance="Appearance.Neutral" IconStart="@(new Icons.Regular.Size24.ChatSparkle())">New Chat</FluentButton>
        </FluentHeader>
    </div>
    <div class="chat-messages">
        @if (this.chatHistory.Any())
        {
            @foreach (ChatMessageContent message in this.chatHistory)
            {
                if ((message.Role.ToString().ToLower() == "tool" && !DisplayToolMessages) || string.IsNullOrEmpty(message.Content))
                {
                    continue;
                }

                <div class="@message.Role.ToString().ToLower() message-card">
                    <div class="@message.Role.ToString().ToLower() message-container">
                        @if (message.Role.ToString() == "user")
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size24.PersonChat())"/>
                        }
                        else if (message.Role.ToString().ToLower() == "tool" && DisplayToolMessages)
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size24.Wrench())" />
                        }
                        else
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size24.Bot())"/>
                        }
                        <div class="message-content">
                            @if (!string.IsNullOrEmpty(message.Content))
                            {
                                @((MarkupString)Markdown.ToHtml(message.Content, this.pipeline))
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <FluentLabel>No messages yet. Start the conversation!</FluentLabel>
        }
        <FluentProgressRing Visible="@(this.loading)" style="width: 42px; height: 82px; position: absolute; bottom: 50%; left: 50%;"></FluentProgressRing>
    </div>
    <div class="chat-input">
        <FluentStack Orientation="Orientation.Horizontal" Width="100%" HorizontalGap="8">
            <FluentTextArea @ref="this.inputTextArea" Immediate="true" ImmediateDelay="15" @bind-Value="this.MessageInput" placeholder="Type a message..." Rows="2" Appearance=FluentInputAppearance.Filled Class="chat-input-area" />
            <FluentButton @ref="this.submitButton" Loading="@(this.loading)" @onclick="this.SendMessage" IconStart="@(new Icons.Regular.Size20.Send())" Appearance="Appearance.Lightweight" Class="send-button">Send</FluentButton>
        </FluentStack>
    </div>
</FluentCard>
<FluentKeyCodeProvider />

@code {
    [Inject]
    private IKeyCodeService KeyCodeService { get; set; }

    private string? MessageInput { get; set; }
    private bool loading = false;
    private const bool DisplayToolMessages = false;
    private readonly ChatHistory chatHistory = [];
    private FluentButton submitButton = new();
    private FluentTextArea inputTextArea = new();
    private readonly MarkdownPipeline pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseBootstrap()
        .UseEmojiAndSmiley()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        // This is used by Blazor to capture the user input for shortcut keys.
        this.KeyCodeService.RegisterListener(this.OnKeyDownAsync);
        await this.LoadChatHistory();
    }

    private async Task LoadChatHistory()
    {
        this.loading = true;
        this.loading = false;
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrEmpty(this.MessageInput))
        {
            return;
        }

        this.loading = true;

        this.chatHistory.AddUserMessage(this.MessageInput);
        this.chatHistory.AddAssistantMessage("TEST");

        this.MessageInput = string.Empty;
        await this.LoadChatHistory();
    }

    private async Task ClearChat()
    {
        this.loading = true;
        this.chatHistory.Clear();
        await this.LoadChatHistory();
    }

    private async Task OnKeyDownAsync(FluentKeyCodeEventArgs args)
    {
        if (args is { CtrlKey: true, Value: "Enter" })
        {
            // Ctrl + Enter Pressed
            await this.InvokeAsync(async () =>
            {
                this.StateHasChanged();
                await Task.Delay(180);
                await this.submitButton.OnClick.InvokeAsync();
            });
        }
    }
}